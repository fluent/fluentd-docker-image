# escape=`
FROM microsoft/windowsservercore:1803

# Download and install chocolatey to get ruby. Chocolatey is removed at a later step
RUN powershell -Command "Set-ExecutionPolicy Bypass -Scope Process -Force; iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))" 

# Fluentd depends on cool.io which is only available for Ruby < 2.5, so need to install Ruby < 2.5 and install msys2 to get dev tools
RUN choco install -y ruby --version 2.4.2.2 --params "'/InstallDir:C:\'" `
&& choco install -y msys2 --params "'/NoPath /NoUpdate /InstallDir:C:\ruby24\msys64'" `
&& refreshenv `
&& ridk install 2 3 `
&& echo gem: --no-document >> C:\ProgramData\gemrc `
&& gem install oj -v 3.3.10 `
&& gem install cool.io -v 1.5.3 `
&& gem install json -v 2.1.0 `
&& gem install fluentd -v 1.2.4 `
&& gem install win32-service -v 1.0.1 `
&& gem install win32-ipc -v 0.7.0 `
&& gem install win32-event -v 0.6.3 `
&& gem install windows-pr -v 1.2.6 `
&& gem sources --clear-all

# Remove gem cache and chocolatey
RUN powershell -Command "del C:\ruby24\lib\ruby\gems\2.4.0\cache\*.gem; Remove-Item -Recurse -Force C:\ProgramData\chocolatey"

COPY fluent.conf /fluent/conf/fluent.conf

EXPOSE 24224 5140
ENTRYPOINT ["cmd", "/k", "fluentd", "-c", "C:\\fluent\\conf\\fluent.conf"]

